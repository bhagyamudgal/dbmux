name: Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write
    id-token: write

jobs:
    release:
        name: Build, Publish, and Release
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  registry-url: "https://registry.npmjs.org"

            - name: Cache Bun dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Build project
              run: bun run build

            - name: Build cross-platform binaries
              run: bun run build:binaries

            - name: Create checksums
              run: |
                  cd packages/cli/binaries
                  sha256sum * > checksums.txt
                  cat checksums.txt

            - name: Get version from tag
              id: get_version
              run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

            - name: Publish to npm (Trusted Publishing)
              run: npm publish --provenance --access public
              working-directory: packages/cli

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ github.ref_name }}
                  name: Release ${{ steps.get_version.outputs.VERSION }}
                  body: |
                      ## DBMux ${{ steps.get_version.outputs.VERSION }}

                      ### Installation

                      **Quick Install (Recommended):**
                      ```bash
                      curl -fsSL https://raw.githubusercontent.com/bhagyamudgal/dbmux/main/install.sh | bash
                      ```

                      **Via npm:**
                      ```bash
                      npm install -g dbmux
                      # or
                      bun add -g dbmux
                      ```

                      **Via Binary Download:**

                      | Platform | Binary |
                      |----------|--------|
                      | Linux (x64) | `dbmux-linux-x64` |
                      | macOS (Intel) | `dbmux-darwin-x64` |
                      | macOS (Apple Silicon) | `dbmux-darwin-arm64` |
                      | Windows (x64) | `dbmux-windows-x64.exe` |

                      ```bash
                      # Linux/macOS
                      chmod +x dbmux-*
                      sudo mv dbmux-* /usr/local/bin/dbmux
                      dbmux --help
                      ```

                      ### Verification

                      Verify downloads using `checksums.txt` (SHA256).
                  draft: false
                  prerelease: false
                  files: |
                      packages/cli/binaries/dbmux-linux-x64
                      packages/cli/binaries/dbmux-darwin-x64
                      packages/cli/binaries/dbmux-darwin-arm64
                      packages/cli/binaries/dbmux-windows-x64.exe
                      packages/cli/binaries/checksums.txt
